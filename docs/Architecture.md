---
title: "Architecture Overview"
description: "This viewer is part of the , consisting of 8 interconnected projects:"
version: "1.0.0"
last_updated: "2026-01-25"
author: "AngocA"
tags:
  - "architecture"
audience:
  - "developers"
project: "OSM-Notes-Viewer"
status: "active"
---


# Architecture Overview

## System Architecture

### Complete Ecosystem

This viewer is part of the **OSM-Notes ecosystem**, consisting of 8 interconnected projects:

```mermaid
graph TB
    subgraph External["External Sources"]
        OSM[OpenStreetMap Planet<br/>XML Dump + API Endpoints]
    end
    
    subgraph Ingestion["Data Ingestion Layer"]
        INGESTION[OSM-Notes-Ingestion<br/>Base Project<br/>- Downloads Planet dumps<br/>- Syncs via OSM API<br/>- Stores raw notes in PostgreSQL<br/>- Handles incremental updates]
        BASE_DB[(PostgreSQL<br/>Base Database)]
    end
    
    subgraph Processing["Processing Layer"]
        ANALYTICS[OSM-Notes-Analytics<br/>ETL + Data Warehouse<br/>- Processes raw notes<br/>- Creates data warehouse<br/>- Generates statistics<br/>- Exports to JSON files]
        WMS[OSM-Notes-WMS<br/>Web Map Service<br/>- Geographic visualization<br/>- WMS layers]
    end
    
    subgraph Data["Data Repository"]
        DATA[OSM-Notes-Data<br/>JSON Files - GitHub Pages<br/>- User profiles JSON<br/>- Country profiles JSON<br/>- Index files]
    end
    
    subgraph Delivery["Delivery Layer"]
        VIEWER[OSM-Notes-Viewer<br/>Static Web App<br/>This project<br/>Consumes Data]
        API[OSM-Notes-API<br/>REST API<br/>- Dynamic queries<br/>- Reads from Analytics]
    end
    
    subgraph Monitoring["Monitoring Layer"]
        MONITORING[OSM-Notes-Monitoring<br/>Monitoring & Alerting<br/>Monitors All]
    end
    
    OSM -->|Download| INGESTION
    INGESTION -->|Stores| BASE_DB
    BASE_DB -->|Raw Notes Data| ANALYTICS
    BASE_DB -->|Same Database| WMS
    ANALYTICS -->|JSON Export| DATA
    ANALYTICS -->|Reads DWH| API
    DATA -->|JSON Files| VIEWER
    MONITORING -.->|Monitors| INGESTION
    MONITORING -.->|Monitors| ANALYTICS
    MONITORING -.->|Monitors| API
    
    style OSM fill:#ADD8E6
    style INGESTION fill:#90EE90
    style BASE_DB fill:#90EE90
    style ANALYTICS fill:#FFFFE0
    style WMS fill:#FFE4B5
    style DATA fill:#E0F6FF
    style VIEWER fill:#DDA0DD
    style API fill:#FFB6C1
    style MONITORING fill:#F0E68C
```

**Note:** OSM-Notes-Common (shared libraries) is used as Git submodule by Ingestion, Analytics, WMS, and Monitoring (not by Viewer or API).

### OSM Notes Ecosystem (8 Projects)

1. **OSM-Notes-Ingestion** (base project) - Data ingestion from Planet/API
2. **OSM-Notes-Analytics** - ETL and data warehouse (generates Data)
3. **OSM-Notes-Data** - JSON files served via GitHub Pages (consumed by Viewer)
4. **OSM-Notes-Viewer** (this project) - Web application consuming Data
5. **OSM-Notes-API** - REST API (complementary to Viewer, reads from Analytics)
6. **OSM-Notes-WMS** - Web Map Service (geographic visualization)
7. **OSM-Notes-Monitoring** - Monitors all ecosystem components
8. **OSM-Notes-Common** - Shared libraries (Git submodule, used by Ingestion, Analytics, WMS, Monitoring)

**Note**: Viewer primarily consumes static JSON from OSM-Notes-Data (GitHub Pages), which is generated by OSM-Notes-Analytics. Viewer can also use OSM-Notes-API for dynamic queries and OSM-Notes-WMS for map layers.

See the main [README.md](../README.md) for complete ecosystem overview.

## Frontend Architecture

### Layer Structure

```mermaid
graph TB
    subgraph Presentation["Presentation Layer"]
        HTML[HTML Pages + CSS Styling]
    end
    
    subgraph Components["Component Layer"]
        COMP1[activityHeatmap.js]
        COMP2[workingHoursHeatmap.js]
        COMP_DESC[Reusable UI Components]
    end
    
    subgraph Business["Business Logic"]
        MAIN[main.js]
        USER[userProfile.js]
        COUNTRY[countryProfile.js]
        NOTE[noteViewer.js]
        HASHTAG[hashtagViewer.js]
        MAP[mapViewer.js]
        DESC[Page Controllers]
    end
    
    subgraph Data["Data Layer"]
        API_CLIENT[apiClient.js<br/>Static JSON API]
        REST_API[REST API calls<br/>OSM-Notes-API]
        WMS_INTEG[WMS layer integration<br/>GeoServer]
        CACHE[cache.js<br/>LocalStorage]
        FORMATTER[formatter.js<br/>Utilities]
    end
    
    Business -->|Uses| Components
    Components -->|Renders| Presentation
    Business -->|Uses| Data
    Data -->|Provides Data| Business
    
    subgraph Config["Configuration"]
        API_CONFIG[api-config.js<br/>Static JSON]
        REST_CONFIG[REST API endpoints<br/>OSM-Notes-API]
        WMS_CONFIG[WMS configuration<br/>GeoServer]
    end
    
    Business -->|Uses| Components
    Components -->|Renders| Presentation
    Business -->|Uses| Data
    Data -->|Provides Data| Business
    Config -->|Configures| Data
    
    style Presentation fill:#DDA0DD
    style Components fill:#FFE4B5
    style Business fill:#FFFFE0
    style Data fill:#E0F6FF
    style Config fill:#F0E68C
```

## Data Flow

### 1. Initial Page Load

```mermaid
flowchart TD
    START[User visits page]
    START --> LOAD[Load HTML/CSS/JS]
    LOAD --> INIT[main.js initializes]
    INIT --> CHECK_CACHE{Check localStorage<br/>cache}
    
    CHECK_CACHE -->|Cache valid| USE_CACHE[Use cached data]
    CHECK_CACHE -->|Cache invalid<br/>or missing| FETCH[Fetch from API]
    
    FETCH --> STORE[Store in cache]
    STORE --> RENDER[Render UI]
    USE_CACHE --> RENDER
    
    style START fill:#90EE90
    style RENDER fill:#90EE90
    style USE_CACHE fill:#E0F6FF
    style FETCH fill:#FFE4B5
```

### 2. Search Flow

```mermaid
flowchart TD
    START[User types in search]
    START --> FETCH[Fetch index.json<br/>users or countries]
    FETCH --> FILTER[Filter results<br/>client-side]
    FILTER --> DISPLAY[Display matching<br/>results]
    DISPLAY --> CLICK[User clicks result]
    CLICK --> NAVIGATE[Navigate to profile page]
    
    style START fill:#90EE90
    style NAVIGATE fill:#90EE90
    style FETCH fill:#FFE4B5
    style FILTER fill:#FFFFE0
```

### 3. Profile Page Flow

```mermaid
flowchart TD
    START[Profile page loads]
    START --> EXTRACT[Extract ID from<br/>URL params]
    EXTRACT --> CHECK_CACHE{Check cache}
    
    CHECK_CACHE -->|Cache hit| RENDER[Render immediately]
    CHECK_CACHE -->|Cache miss| FETCH[Fetch /users/id.json<br/>or /countries/id.json]
    
    FETCH --> PARSE[Parse JSON]
    PARSE --> STORE[Store in cache]
    STORE --> RENDER
    
    style START fill:#90EE90
    style RENDER fill:#90EE90
    style FETCH fill:#FFE4B5
    style STORE fill:#E0F6FF
```
    RENDER_COMP[Render components<br/>- Statistics cards<br/>- Activity heatmap<br/>- Hashtags<br/>- Rankings<br/>- Working hours]
    
    style START fill:#90EE90
    style RENDER fill:#90EE90
    style FETCH fill:#FFE4B5
    style STORE fill:#E0F6FF
    style RENDER_COMP fill:#DDA0DD
```

### 4. Note Viewer Flow

```mermaid
flowchart TD
    START[Note viewer page loads]
    START --> EXTRACT[Extract note ID from<br/>URL params]
    EXTRACT --> FETCH_NOTE[Fetch note from OSM-Notes-API<br/>GET /api/v1/notes/noteId]
    FETCH_NOTE --> PARSE[Parse note data<br/>GeoJSON format]
    PARSE --> RENDER_INFO[Render note information<br/>- Status badge<br/>- Map with location<br/>- Note content and hashtags<br/>- Activity timeline<br/>- Comment form]
    
    RENDER_INFO --> FETCH_COUNTRY[Fetch country info<br/>from OSM-Notes-API<br/>GET /api/v1/notes/noteId<br/>includes country]
    
    FETCH_COUNTRY --> CHECK_OPEN{Note is open?}
    CHECK_OPEN -->|Yes| FETCH_ML[Fetch ML recommendation<br/>GET /api/v1/notes/noteId/recommendation]
    CHECK_OPEN -->|No| END[End]
    
    FETCH_ML --> RENDER_ML[Render ML recommendation<br/>- Recommended action<br/>- Confidence score<br/>- JOSM tags if action is map]
    RENDER_ML --> END
    
    style START fill:#90EE90
    style END fill:#90EE90
    style FETCH_NOTE fill:#FFE4B5
    style FETCH_COUNTRY fill:#FFE4B5
    style FETCH_ML fill:#DDA0DD
    style RENDER_INFO fill:#FFFFE0
    style RENDER_ML fill:#E0F6FF
```

### 5. Hashtag Viewer Flow

```mermaid
flowchart TD
    START[Hashtag viewer page loads]
    START --> EXTRACT[Extract hashtag from<br/>URL params]
    EXTRACT --> FETCH_DETAILS[Fetch hashtag details<br/>from OSM-Notes-API<br/>GET /api/v1/hashtags/hashtag]
    FETCH_DETAILS --> FETCH_NOTES[Fetch notes with hashtag<br/>GET /api/v1/notes?text=#hashtag<br/>&page=page&limit=limit]
    FETCH_NOTES --> APPLY_FILTERS[Apply filters<br/>status, date_from, date_to]
    APPLY_FILTERS --> RENDER_HEADER[Render hashtag header<br/>with stats]
    RENDER_HEADER --> RENDER_LIST[Render notes list<br/>with pagination]
    
    style START fill:#90EE90
    style RENDER_LIST fill:#90EE90
    style FETCH_DETAILS fill:#FFE4B5
    style FETCH_NOTES fill:#FFE4B5
    style APPLY_FILTERS fill:#FFFFE0
    style RENDER_HEADER fill:#E0F6FF
```

### 6. Map Viewer Flow

```mermaid
flowchart TD
    START[Map viewer page loads]
    START --> REQUEST_LOC[Request user geolocation<br/>navigator.geolocation.getCurrentPosition]
    REQUEST_LOC --> CALC_BBOX[Calculate 500km bounding box<br/>calculateBbox lat, lon, 500]
    CALC_BBOX --> INIT_MAPS[Initialize Leaflet maps<br/>3 maps:<br/>- Open Notes map<br/>- Closed Notes map<br/>- Boundaries map]
    INIT_MAPS --> ADD_BASE[Add base layers<br/>OSM, Satellite]
    ADD_BASE --> ADD_WMS[Add WMS layers from GeoServer<br/>- osm_notes:notesopen<br/>- osm_notes:notesclosed<br/>- osm_notes:countries<br/>- osm_notes:disputedareas]
    ADD_WMS --> SET_VIEW[Set initial view<br/>500km bbox for notes maps]
    SET_VIEW --> SETUP_POPUP[Setup GetFeatureInfo<br/>for note popups]
    
    style START fill:#90EE90
    style SETUP_POPUP fill:#90EE90
    style REQUEST_LOC fill:#FFE4B5
    style CALC_BBOX fill:#FFFFE0
    style INIT_MAPS fill:#E0F6FF
    style ADD_WMS fill:#DDA0DD
```

## Component Architecture

### API Client (apiClient.js)

**Responsibilities:**

- Fetch static JSON files
- Manage cache
- Handle errors
- Provide typed methods for each endpoint

**Key Methods:**

- `getMetadata()` - Export info
- `getUserIndex()` - All users list
- `getCountryIndex()` - All countries list
- `getUser(id)` - User profile
- `getCountry(id)` - Country profile

### REST API Integration

**Note Viewer (`noteViewer.js`):**

- Fetches individual note details from `OSM-Notes-API`
- Endpoint: `GET /api/v1/notes/{noteId}`
- Fetches ML recommendations: `GET /api/v1/notes/{noteId}/recommendation`
- Base URL: `https://notes-api.osm.lat` (production)

**Hashtag Viewer (`hashtagViewer.js`):**

- Fetches hashtag statistics: `GET /api/v1/hashtags/{hashtag}`
- Fetches notes with hashtag: `GET /api/v1/notes?text=#{hashtag}`
- Supports pagination and filtering (status, date_from, date_to)

**WMS Integration (`mapViewer.js`):**

- Consumes WMS layers from GeoServer
- Base URL: `https://geoserver.osm.lat/geoserver/osm_notes/wms`
- Layers: `osm_notes:notesopen`, `osm_notes:notesclosed`, `osm_notes:countries`,
  `osm_notes:disputedareas`
- Uses `leaflet.wms` plugin with native Leaflet fallback

### Cache System (cache.js)

**Responsibilities:**

- Store data in localStorage
- Validate cache age
- Clear expired cache
- Manage cache size

**Key Methods:**

- `cacheSet(key, data)` - Store data
- `cacheGet(key, maxAge)` - Retrieve if valid
- `cacheDelete(key)` - Remove entry
- `cacheClear()` - Clear all

### Formatter (formatter.js)

**Responsibilities:**

- Format numbers (1234 → 1,234)
- Format dates (ISO → readable)
- Format percentages
- Truncate text

## Caching Strategy

### Cache Levels

1. **Browser Cache** (HTTP headers)
   - Controlled by CDN/server
   - 15 minutes for data files
   - 1 hour for static assets

2. **LocalStorage Cache** (application level)
   - Managed by cache.js
   - 15 minutes TTL
   - Per-entity caching
   - Survives page refresh

3. **Memory Cache** (apiClient)
   - In-memory Map
   - Cleared on page unload
   - Fastest access

### Cache Keys

```
osm_notes_metadata          → metadata.json
osm_notes_index_users       → indexes/users.json
osm_notes_index_countries   → indexes/countries.json
osm_notes_user_123          → users/123.json
osm_notes_country_456       → countries/456.json
```

## Performance Considerations

### Initial Load Time

**Target:** < 2 seconds on 3G

**Optimizations:**

- Minimal CSS (< 10KB)
- Vanilla JS (no framework overhead)
- Lazy load components
- Cache index files aggressively

### Profile Page Load

**Target:** < 500ms with cache, < 2s without

**Optimizations:**

- Small JSON files (2-10 KB each)
- Client-side rendering
- Progressive loading
- Skeleton screens

### Search Performance

**Strategy:** Client-side filtering

**Why:**

- Index files are small (< 100 KB typically)
- No server required
- Instant results
- Works offline (if cached)

## Scalability

### Current Design Supports:

- **Users:** Up to 100,000 (index ~1 MB)
- **Countries:** Up to 500 (index ~50 KB)
- **JSON files:** Millions (fetched on-demand)

### If Scale Exceeds:

1. **Split index files** by letter/range
2. **Implement server-side search** API
3. **Add pagination** to index
4. **Consider database** backend

## Security Considerations

### Current (Static JSON)

- **No sensitive data** - All OSM data is public
- **No authentication** - Read-only viewer (historical data)
- **HTTPS required** - For CDN and site
- **No XSS risk** - All data properly escaped
- **No CSRF risk** - No state-changing operations

### Future (REST API)

- **Hybrid authentication strategy** - Historical data remains public, recent data requires
  User-Agent
- **User-Agent required** - Valid User-Agent header required for all API endpoints (format:
  `AppName/Version (Contact)`)
- **OAuth 2.0 with OSM** - Optional, only for specific endpoints that require user identity
- **Rate limiting** - Per IP + User-Agent limits for API access
- **Usage analytics** - Track and analyze API usage patterns by application (User-Agent)

This approach is aligned with the [OSM-Notes-API proposal](../OSM-Notes-API/docs/API_Proposal.md).
For detailed information about the authentication strategy, see
[AUTHENTICATION_STRATEGY.md](Authentication_Strategy.md).

## Browser Compatibility

### Required Features:

- ES6 Modules
- Fetch API
- LocalStorage
- Promises/async-await
- CSS Grid

### Minimum Versions:

- Chrome: 61+
- Firefox: 60+
- Safari: 11+
- Edge: 79+

### Progressive Enhancement:

- Core functionality works without JS (minimal)
- Enhanced with JS modules
- Graceful degradation for older browsers

## Data Sources

### Static JSON Files (Historical Data)

- **Base URL:** `https://notes.osm.lat/data`
- **Format:** Pre-generated JSON files
- **Update Frequency:** Every 15 minutes
- **Caching:** 15 minutes TTL
- **Endpoints:**
  - `/metadata.json`
  - `/indexes/users.json`
  - `/indexes/countries.json`
  - `/users/{hex_path}/{user_id}.json`
  - `/countries/{country_id}.json`

### REST API (Recent Data & Features)

- **Base URL:** `https://notes-api.osm.lat`
- **Format:** REST API with JSON responses
- **Update Frequency:** Real-time (updated every 15 minutes)
- **Authentication:** User-Agent header required
- **Endpoints:**
  - `GET /api/v1/notes/{noteId}` - Individual note details
  - `GET /api/v1/notes?text={query}` - Search notes
  - `GET /api/v1/hashtags/{hashtag}` - Hashtag statistics
  - `GET /api/v1/notes/{noteId}/recommendation` - ML recommendations

### WMS Service (Map Layers)

- **Base URL:** `https://geoserver.osm.lat/geoserver/osm_notes/wms`
- **Format:** OGC WMS 1.1.0
- **Layers:**
  - `osm_notes:notesopen` - Open notes
  - `osm_notes:notesclosed` - Closed notes
  - `osm_notes:countries` - Country boundaries
  - `osm_notes:disputedareas` - Disputed areas
- **Features:** GetFeatureInfo for note popups

## ML Integration

### ML Recommendations API

- **Endpoint:** `GET /api/v1/notes/{noteId}/recommendation`
- **Response Format:**
  ```json
  {
    "action": "close|comment|map",
    "confidence": 0.0-1.0,
    "reason": "Explanation text",
    "tags": {
      "amenity": "restaurant",
      "name": "Example"
    }
  }
  ```
- **Usage:** Only shown for open notes
- **JOSM Tags:** If action is "map", tags are formatted for JOSM editor

## Future Architecture

### Potential Enhancements:

1. **Service Worker** for offline mode (PWA support)
2. **IndexedDB** for larger cache
3. **WebSocket** for real-time updates
4. **GraphQL** layer for flexible queries
5. **Server-Side Rendering** for better SEO
6. **Web Components** for better encapsulation
7. **OAuth Integration** for note actions (comment, close, reopen)

### Migration Path:

Current (Vanilla JS) → React/Vue → Next.js/Nuxt → Full-stack

Each step adds complexity but also features. Start simple, evolve as needed.
