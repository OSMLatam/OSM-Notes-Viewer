# API Documentation

This document describes the JSON data structure consumed by OSM Notes Viewer.

## Overview

All data is served as static JSON files generated by the OSM-Notes-Analytics backend. The viewer
fetches these files directly without any API server.

## Base Structure

```
/api/
‚îú‚îÄ‚îÄ metadata.json           # Export metadata
‚îú‚îÄ‚îÄ indexes/
‚îÇ   ‚îú‚îÄ‚îÄ users.json         # List of all users
‚îÇ   ‚îî‚îÄ‚îÄ countries.json     # List of all countries
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îî‚îÄ‚îÄ {user_id}.json    # Individual user profiles
‚îî‚îÄ‚îÄ countries/
    ‚îî‚îÄ‚îÄ {country_id}.json  # Individual country profiles
```

---

## Endpoints

### 1. Metadata

**Path:** `/api/metadata.json`

**Description:** Contains information about the data export.

**Response:**

```json
{
  "export_date": "2025-10-21T15:30:00Z",
  "total_users": 123456,
  "total_countries": 195,
  "version": "2025-10-21"
}
```

**Fields:**

- `export_date` (string): ISO 8601 timestamp of when data was exported
- `total_users` (number): Total number of users in the dataset
- `total_countries` (number): Total number of countries
- `version` (string): Version identifier

---

### 2. User Index

**Path:** `/api/indexes/users.json`

**Description:** List of all users with basic statistics. Used for search and leaderboards.

**Response:**

```json
[
  {
    "user_id": 12345,
    "username": "example_user",
    "history_whole_open": 1234,
    "history_whole_closed": 567,
    "history_year_open": 45,
    "history_year_closed": 23
  },
  ...
]
```

**Fields:**

- `user_id` (number): OSM user ID
- `username` (string): OSM username
- `history_whole_open` (number): Total notes opened (lifetime)
- `history_whole_closed` (number): Total notes closed (lifetime)
- `history_year_open` (number): Notes opened this year
- `history_year_closed` (number): Notes closed this year

---

### 3. Country Index

**Path:** `/api/indexes/countries.json`

**Description:** List of all countries with basic statistics.

**Response:**

```json
[
  {
    "country_id": 123456,
    "country_name": "Colombia",
    "country_name_es": "Colombia",
    "country_name_en": "Colombia",
    "history_whole_open": 5420,
    "history_whole_closed": 2340,
    "history_year_open": 450,
    "history_year_closed": 230
  },
  ...
]
```

**Fields:**

- `country_id` (number): OSM country relation ID
- `country_name` (string): Country name (local language)
- `country_name_es` (string): Country name in Spanish
- `country_name_en` (string): Country name in English
- `history_whole_open` (number): Total notes opened (lifetime)
- `history_whole_closed` (number): Total notes closed (lifetime)
- `history_year_open` (number): Notes opened this year
- `history_year_closed` (number): Notes closed this year

---

### 4. User Profile

**Path:** `/api/users/{user_id}.json`

**Example:** `/api/users/12345.json`

**Description:** Complete profile for a specific user with all statistics.

**Response:**

```json
{
  "dimension_user_id": 123,
  "user_id": 12345,
  "username": "example_user",
  "date_starting_creating_notes": "2015-03-20",
  "date_starting_solving_notes": "2015-04-15",
  "first_open_note_id": 100,
  "first_closed_note_id": 200,
  "id_contributor_type": 2,
  "last_year_activity": "001002003...",
  "lastest_open_note_id": 999,
  "lastest_closed_note_id": 888,
  "dates_most_open": [
    { "rank": 1, "date": "2024-03-15", "quantity": 45 },
    { "rank": 2, "date": "2024-05-20", "quantity": 38 }
  ],
  "dates_most_closed": [{ "rank": 1, "date": "2024-06-10", "quantity": 23 }],
  "hashtags": [
    { "rank": 1, "hashtag": "#mapathon", "quantity": 45 },
    { "rank": 2, "hashtag": "#survey", "quantity": 23 }
  ],
  "countries_open_notes": [
    { "rank": 1, "country": "Colombia", "quantity": 150 },
    { "rank": 2, "country": "Ecuador", "quantity": 45 }
  ],
  "countries_solving_notes": [{ "rank": 1, "country": "Colombia", "quantity": 80 }],
  "working_hours_of_week_opening": [
    { "hour": 0, "day": "Monday", "quantity": 5 },
    { "hour": 1, "day": "Monday", "quantity": 2 }
  ],
  "working_hours_of_week_closing": [],
  "history_whole_open": 542,
  "history_whole_commented": 123,
  "history_whole_closed": 234,
  "history_whole_closed_with_comment": 189,
  "history_whole_reopened": 12,
  "history_year_open": 45,
  "history_year_commented": 10,
  "history_year_closed": 23,
  "history_year_closed_with_comment": 20,
  "history_year_reopened": 2,
  "history_month_open": 5,
  "history_month_closed": 3,
  "history_day_open": 0,
  "history_day_closed": 1
}
```

**Key Fields:**

- **Basic Info:** `user_id`, `username`, `date_starting_*`
- **Activity:** `history_*` (whole/year/month/day)
- **Rankings:** `dates_most_*`, `hashtags`, `countries_*`
- **Patterns:** `working_hours_of_week_*`, `last_year_activity`
- **Milestones:** `first_*_note_id`, `lastest_*_note_id`

---

### 5. Country Profile

**Path:** `/api/countries/{country_id}.json`

**Example:** `/api/countries/123456.json`

**Description:** Complete profile for a specific country.

**Response:**

```json
{
  "dimension_country_id": 123,
  "country_id": 123456,
  "country_name": "Colombia",
  "country_name_es": "Colombia",
  "country_name_en": "Colombia",
  "date_starting_creating_notes": "2013-06-15",
  "date_starting_solving_notes": "2013-07-20",
  "first_open_note_id": 50,
  "first_closed_note_id": 75,
  "last_year_activity": "012034056...",
  "hashtags": [
    { "rank": 1, "hashtag": "#mapathon", "quantity": 450 },
    { "rank": 2, "hashtag": "#survey", "quantity": 230 }
  ],
  "users_open_notes": [
    { "rank": 1, "username": "user1", "quantity": 1500 },
    { "rank": 2, "username": "user2", "quantity": 450 }
  ],
  "users_solving_notes": [{ "rank": 1, "username": "user3", "quantity": 800 }],
  "working_hours_of_week_opening": [],
  "working_hours_of_week_closing": [],
  "history_whole_open": 5420,
  "history_whole_commented": 1230,
  "history_whole_closed": 2340,
  "history_whole_closed_with_comment": 1890,
  "history_whole_reopened": 120,
  "history_year_open": 450,
  "history_year_closed": 230,
  "history_month_open": 50,
  "history_month_closed": 30
}
```

**Key Fields:**

- **Basic Info:** `country_id`, `country_name_*`
- **Activity:** `history_*` (whole/year/month/day)
- **Rankings:** `hashtags`, `users_*_notes`
- **Patterns:** `working_hours_of_week_*`, `last_year_activity`

---

## Data Types

### Activity String (last_year_activity)

**Format:** String of 371 characters representing last year's daily activity.

**Structure:** GitHub-style contribution calendar where each character represents note activity for
a day:

- `0` = 0 notes
- `1` = 1-2 notes
- `2` = 3-5 notes
- `3` = 6-10 notes
- `4` = 11-20 notes
- `5` = 21-50 notes
- `6` = 51-100 notes
- `7` = 101-200 notes
- `8` = 201-500 notes
- `9` = 501+ notes

**Usage:** Render as heatmap (53 weeks √ó 7 days)

### Working Hours

**Format:** Array of objects with hour/day/quantity

**Structure:**

```json
[
  {
    "hour": 0, // 0-23
    "day": "Monday",
    "quantity": 5
  }
]
```

**Usage:** Visualize as heatmap (24 hours √ó 7 days)

---

## Caching Recommendations

- **metadata.json**: 5 minutes
- **indexes/\*.json**: 15 minutes
- **users/\*.json**: 15 minutes
- **countries/\*.json**: 15 minutes

---

## Error Handling

### 404 Not Found

User or country doesn't exist in the dataset.

### Network Errors

Implement retry logic with exponential backoff.

### Invalid JSON

Log error and show user-friendly message.

---

## Example Client Code

```javascript
// Fetch user profile
async function fetchUser(userId) {
  try {
    const response = await fetch(`/api/users/${userId}.json`);
    if (!response.ok) {
      throw new Error(`User ${userId} not found`);
    }
    return await response.json();
  } catch (error) {
    console.error('Error fetching user:', error);
    throw error;
  }
}
```

---

## Data Update Frequency

- New data exported every **15 minutes**
- Users with new activity updated incrementally
- Full rebuild performed daily

---

## Rate Limiting

### Static JSON Files

No rate limiting since all files are static. However, implement client-side caching to reduce
unnecessary requests.

### API REST Endpoints (Future)

When the REST API is implemented, rate limiting will apply:

- **Authenticated users**: 1000 requests/hour
- **Rate limit headers**: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`

---

## Authentication Strategy

This project uses a **hybrid authentication strategy**:

### Public Access (No Authentication Required)

The following endpoints are publicly accessible via static JSON files:

- `/api/metadata.json`
- `/api/indexes/users.json`
- `/api/indexes/countries.json`
- `/api/users/{user_id}.json` (historical data)
- `/api/countries/{country_id}.json` (historical data)

These contain **historical data** exported daily and are suitable for general viewing and analysis.

### API REST Access (User-Agent Required)

Future REST API endpoints for **recent data** (updated every 15 minutes) will require a valid
**User-Agent header**:

- `GET /api/v1/users/{user_id}/recent-activity` ‚ö†Ô∏è
- `GET /api/v1/countries/{country_id}/current-stats` ‚ö†Ô∏è
- `GET /api/v1/global/current-stats` ‚ö†Ô∏è
- Dynamic queries (search, filters, rankings) ‚ö†Ô∏è

**User-Agent Format Required**: `AppName/Version (Contact)`

**Example**: `OSMNotesViewer/1.0 (https://github.com/OSM-Notes/OSM-Notes-Viewer)`

**Benefits**:

- Control access to real-time data
- Reduce abuse and enable rate limiting (by IP + User-Agent)
- Track usage patterns by application for platform improvement
- Enable geographic analysis of users (via IP geolocation)
- Lower friction for developers (no OAuth required for most endpoints)

**OAuth with OSM**: Optional, only required for specific endpoints that need user identity (e.g.,
`/api/v1/users/me/*`)

This approach is aligned with the [OSM-Notes-API proposal](../OSM-Notes-API/docs/API_Proposal.md).

**Client-Side Protection**: The viewer implements client-side rate limiting, aggressive caching, and
abuse detection to prevent overloading the server. See
[AUTHENTICATION_STRATEGY.md](AUTHENTICATION_STRATEGY.md#üõ°Ô∏è-protecci√≥n-del-lado-del-cliente-viewer)
for details.

For detailed information about the authentication strategy, see
[AUTHENTICATION_STRATEGY.md](AUTHENTICATION_STRATEGY.md).

---

## Future API Endpoints (Planned)

These endpoints will be available once the REST API backend is implemented. All require a valid
User-Agent header (format: `AppName/Version (Contact)`). OAuth is optional and only required for
specific endpoints.

### User Endpoints

```
GET /api/v1/users/{user_id}/recent-activity
  Authentication: User-Agent required (format: AppName/Version (Contact))
  Returns: {
    notes_created_last_30_days: number,
    notes_resolved_last_30_days: number,
    days_since_last_action: number,
    active_notes_count: number,
    countries_open_notes_current_month: array,
    countries_solving_notes_current_month: array,
    countries_open_notes_current_day: array,
    countries_solving_notes_current_day: array
  }
```

### Country Endpoints

```
GET /api/v1/countries/{country_id}/current-stats
  Authentication: User-Agent required (format: AppName/Version (Contact))
  Returns: {
    currently_open_count: number,
    currently_closed_count: number,
    notes_created_last_30_days: number,
    notes_resolved_last_30_days: number,
    notes_backlog_size: number,
    active_notes_count: number,
    notes_health_score: number,
    new_vs_resolved_ratio: number
  }
```

### Global Endpoints

```
GET /api/v1/global/current-stats
  Authentication: User-Agent required (format: AppName/Version (Contact))
  Returns: {
    currently_open_count: number,
    currently_closed_count: number,
    notes_created_last_30_days: number,
    notes_resolved_last_30_days: number,
    notes_backlog_size: number,
    active_users_count: number,
    notes_age_distribution: object
  }
```

### Dynamic Query Endpoints

```
GET /api/v1/users?country={id}&min_notes={count}&sort={field}&limit={count}
GET /api/v1/countries?health_score_min={score}&sort={field}&limit={count}
GET /api/v1/users?hashtag={tag}&date_from={date}&date_to={date}
GET /api/v1/users/rankings?metric={field}&limit={count}
GET /api/v1/countries/rankings?metric={field}&limit={count}
GET /api/v1/compare/users?ids={id1,id2,id3}
GET /api/v1/compare/countries?ids={id1,id2,id3}
```

All dynamic query endpoints require a valid User-Agent header. OAuth is optional.

For complete details on which metrics require API access, see [API_METRICS.md](API_METRICS.md).
