#!/bin/bash

# Pre-commit hook for OSM-Notes-Viewer
# Unified Git hook for JavaScript/HTML/CSS projects
# Author: Andres Gomez (AngocA)
# Version: 2026-01-27
# Runs quality checks before allowing commit
#
# To install: ln -sf ../../.git-hooks/pre-commit .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged files by type
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)
STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|json|yaml|yml|css|html)$' || true)

if [ -z "$STAGED_JS_FILES" ] && [ -z "$STAGED_FORMAT_FILES" ]; then
    echo "‚ÑπÔ∏è  No files requiring format checks staged for commit"
    exit 0
fi

# Check 1: Prettier formatting (JavaScript/TypeScript/HTML/CSS)
if [ -n "$STAGED_JS_FILES" ] || [ -n "$STAGED_FORMAT_FILES" ]; then
    if command -v prettier &> /dev/null || command -v npx &> /dev/null; then
        echo "üîç Checking formatting with Prettier..."
        PRETTIER_FAILED=0
        
        # Determine prettier command
        if command -v prettier &> /dev/null; then
            PRETTIER_CMD="prettier"
        else
            PRETTIER_CMD="npx prettier"
        fi
        
        # Check JavaScript/TypeScript files
        for file in $STAGED_JS_FILES; do
            if [ -f "$file" ]; then
                if ! $PRETTIER_CMD --check "$file" > /dev/null 2>&1; then
                    PRETTIER_FAILED=1
                    echo -e "${RED}‚ùå Prettier format check failed for: $file${NC}"
                    echo "   Run: $PRETTIER_CMD --write $file"
                fi
            fi
        done
        
        # Check other format files
        for file in $STAGED_FORMAT_FILES; do
            if [ -f "$file" ]; then
                if ! $PRETTIER_CMD --check "$file" > /dev/null 2>&1; then
                    PRETTIER_FAILED=1
                    echo -e "${RED}‚ùå Prettier format check failed for: $file${NC}"
                    echo "   Run: $PRETTIER_CMD --write $file"
                fi
            fi
        done
        
        if [ $PRETTIER_FAILED -eq 1 ]; then
            echo -e "${RED}‚ùå Prettier format check failed. Run prettier --write to fix formatting.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úÖ Prettier format check passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Prettier not installed, skipping format check...${NC}"
    fi
    echo ""
fi

# Check 2: ESLint (if available and JavaScript files are staged)
if [ -n "$STAGED_JS_FILES" ]; then
    if [ -f "package.json" ] && command -v npm &> /dev/null; then
        # Check if eslint is configured
        if grep -q "eslint" package.json || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            echo "üîß Running ESLint..."
            if npm run lint > /dev/null 2>&1 2>/dev/null || true; then
                echo -e "${GREEN}‚úÖ ESLint passed${NC}"
            else
                echo -e "${YELLOW}‚ö†Ô∏è  ESLint check skipped (no lint script configured)${NC}"
            fi
            echo ""
        fi
    fi
fi

echo ""
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""

exit 0
